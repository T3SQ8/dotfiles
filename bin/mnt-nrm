#!/bin/sh

if [ "$(whoami)" != "root" ]; then
	echo "Root privileges needed"; exit
elif [ $# = 0 ]; then
	echo "No device given"; exit
fi

mountdev() {
	mkdir -p "$mntdir" && mount "$1" "$mntdir" && echo "$1 mounted"
}

umountdev() {
	[ "$sync" ] || { echo "Syncing..."; sync ;}
	umount "$1" && rmdir "$mntdir" && echo "$1 unmounted"
	sync=1
}

checkmount(){
	grep -q "$mntdir" /proc/mounts
}

for device in "$@"; do
	shortdev=${device##*/}
	mntdir="/mnt/$shortdev"
	mapper="/dev/mapper/$shortdev"
	parttype=$(blkid -o value -s TYPE "$device")

	[ ! -e "$device" ] && { echo "$device not found"; continue ;}

	case $parttype in
		crypto_LUKS)
			if ! checkmount; then
				cryptsetup open -v "$device" "$shortdev" && mountdev "$mapper"
			else
				umountdev "$mapper" && cryptsetup -v close "$shortdev"
			fi
			;;
		ext4|vfat)
			if ! checkmount; then
				mountdev "$device"
			else
				umountdev "$device"
			fi
			;;
		*)
			echo "Unknown partition type"; exit 1 ;;
	esac
done
