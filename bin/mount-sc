#!/bin/sh

mount_dir="/mnt"
cell_mount_dir="$HOME/cell-mount" # Only for mtp devices
device_regex="sd[b-z]\+[0-9]*"

# Error handling
no_device() { echo "No mountable devices found." ; exit 1 ; }
no_mnt_device() { echo "No devices mounted at '$mount_dir'" ; exit 1 ; }
no_cell_mount_dir() { echo "Mount folder not found." ; exit 1 ; }
no_mtpfs() { echo "Simple-mtpfs not installed." ; exit 1 ; }
no_fusermount() { echo "Fusermount not installed." ; exit 1 ; }

cryptsetup_checker() { [ ! $(command -v cryptsetup) ] &&
	echo "Cryptsetup is not installed." &&
	exit 1
}

device_checker() {
	[ -z "$device" ] && echo "No device given." && exit 1
	[ ! -e /dev/"$device" ] && echo "Device not found." && exit 1
}

# Success messages
success_mnt="Mounted successfully!"
success_umnt="Unmounted successfully!"

echo "1. Mount device"
echo "2. Unmount device"
echo "3. Mount mtp device"
echo "4. Unmount mtp device"
echo "5. Mount LUKS-encrypted device"
echo "6. Unmount LUKS-encrypted device"
printf "What do you want to do? "
read -r choise
echo ""

case "$choise" in
	1)
		lsblk | grep -v "$mount_dir" | grep --color "$device_regex" || no_device # List devices excluding sda (OS disc) and mounted devices
		printf "Which device to you want to mount? "
		read -r device
		device_checker
		sudo mount /dev/"$device" "$mount_dir" && echo "$success_mnt"
		;;
	2)
		lsblk | grep "$mount_dir" | grep --color "$device_regex" || no_mnt_device
		printf "Which device to you want to umount? "
		read -r device
		device_checker
		sudo umount /dev/"$device" && echo "$success_umnt"
		;;
	3)
		[ -d "$cell_mount_dir" ] || no_cell_mount_dir
		command -v simple-mtpfs > /dev/null || no_mtpfs
		simple-mtpfs -l || exit 1
		printf "Which device do you want to mount? "
		read -r device
		simple-mtpfs --device "$device" "$cell_mount_dir" && echo "$success_mnt" || exit 1
		;;
	4)
		[ -d "$cell_mount_dir" ] || no_cell_mount_dir
		command -v fusermount > /dev/null || no_fusermount
		fusermount -u "$cell_mount_dir" && echo "$success_umnt" || exit 1
		;;
	5)
		cryptsetup_checker
		lsblk | grep -v "$mount_dir" | grep --color "$device_regex" || no_device
		printf "Which device to you want to mount? "
		read -r device
		device_checker
		sudo cryptsetup luksOpen /dev/"$device" "$device" || exit 1
		sudo mount /dev/mapper/"$device" "$mount_dir" && echo "$success_mnt"
		;;
	6)
		cryptsetup_checker
		lsblk | grep "$mount_dir" | grep --color "$device_regex" || no_mnt_device
		printf "Which device to you want to umount? "
		read -r device
		device_checker
		sudo umount "$mount_dir"
		sudo cryptsetup luksClose "$device" && echo "$success_umnt"
		;;
	*)
		echo "Invalid option"
		exit 1
		;;
esac
