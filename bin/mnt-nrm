#!/bin/sh

if [ "$(whoami)" != "root" ]; then
	echo "Root privileges needed"; exit
elif [ $# = 0 ]; then
	echo "No device given"; exit
fi

mountdev() {
	mkdir -p "$mntdir"
	mount "$1" "$mntdir"
	echo "$1 mounted"
}

umountdev() {
	echo "Syncing..."; sync
	umount "$1"
	rmdir "$mntdir"
	echo "$1 unmounted"
}

checkmount(){
	grep -q "$1" /proc/mounts
}


for device in "$@"; do
	[ ! -e "$device" ] && { echo "$device not found"; continue ;}

	shortdev=${device##*/}
	mntdir="/mnt/$shortdev"
	mappername="/dev/mapper/$shortdev"

	# If device is encrypted using luks
	if blkid "$device" | grep -q 'TYPE="crypto_LUKS"'; then
		if checkmount "$mappername"; then
			umountdev "$mappername"
			cryptsetup -v close "$shortdev"
		else
			cryptsetup open -v "$device" "$shortdev"
			mountdev "$mappername"
		fi
	else # If device is not encrypted
		if checkmount "$device"; then
			umountdev "$device"
		else
			mountdev "$device"
		fi
	fi
done
