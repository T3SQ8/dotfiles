#!/bin/sh

# Backup home directory into an encrypted tarball locally and onto the cloud

bkpdir="backups"
rclonermt="Google-Drive-Personal"

localfile="$(date +%F).tar.gz"
rmtfile="backups.gpg"
sumfile="checksums.md5"

pkglist="$HOME/.local/installed-packages"
ignorelist="$HOME/.local/backups-ignore"

if [ "${PWD##*/}" != "$bkpdir" ]; then
	printf 'Not in "%s" directory. Do you want to backup to the cloud only? [y/N] ' \
		"$bkpdir"
	read -r cloud_only
	case $cloud_only in
		y|Y|yes|Yes|YES) cloud_only=1 ;;
		*) exit 1 ;;
	esac
fi

pacman -Qqe > "$pkglist"

if [ $cloud_only ]; then
	tar -cvzX "$ignorelist" "$HOME" |
		gpg -c |
		rclone rcat "$rclonermt:$rmtfile"
else
	tar -cvzX "$ignorelist" "$HOME" |
		gpg -c |
		tee "$localfile.gpg" |
		rclone rcat "$rclonermt:$rmtfile"
	md5sum "$localfile.gpg" >> "$sumfile"
fi
