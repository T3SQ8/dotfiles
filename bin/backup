#!/bin/sh

dir="backups-computer"
file="$(date +%Y-%m-%d).tar.gz"
rmtfile="$file.gpg"
pkglist="$HOME/.local/installed-packages.txt"
difflist="$HOME/.local/backups-differential"
ignorelist="$HOME/.local/backups-ignore"
sumfile="checksums.md5"

[ "${PWD##*/}" != "$dir" ] && { echo "Wrong directory"; exit 1 ;}

pacman -Qqe > "$pkglist"
rsync -aPr --files-from "$difflist" "$HOME/" differential
tar -cvz -X "$ignorelist" -X "$difflist" "$HOME" | tee "$file" | gpg -c | rclone rcat "backups:$rmtfile"
md5sum "$file" >> "$sumfile"
