#!/bin/sh

while getopts omf:i:d:a: arg; do
	case $arg in
		f) sumfile=$OPTARG ;;
		o) force=1 ;;
		m) missing=1 ;;
		a) hashalgo=$OPTARG ;;
		i) add_ignore_list "$OPTARG" ;;
		d) dir=$OPTARG ;;
		\?) exit 1 ;;
	esac
done
sumfile=${sumfile:-checksum.md5}
dir=${dir:-.}
hashalgo=${hashalgo:-md5sum}

[ -f "$sumfile" ] && [ ! "$force" ] && [ ! "$missing" ] && {
	echo "'$sumfile' already exists. Please specify the -m option to only add missing files or the -o option to continue."; exit 1
}

if [ "$missing" ]; then
	find "$dir" -type f | while read -r file; do
		grep -qF "$file" "$sumfile" || $hashalgo "$file" >> "$sumfile"
	done
else
	find "$dir" -type f -exec $hashalgo '{}' + >> "$sumfile"
fi
